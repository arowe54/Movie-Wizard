{% extends "layout.html" %}

{% block title %}
    Search
{% endblock %}

{% block main %}
<!--Lookup a Movie-->
<form class="d-flex" action="/search" method="get" autocomplete="on" id="search_form" role="search">
    <input class="form-control me-2" type="search" id="title" name="title" placeholder="Search a Title" aria-label="Search">
    <button class="btn btn-outline-success" type="submit">Search</button>
</form>
<!--Get Random movies button-->
<form action="/search" method="get" autocomplete="on">
    <input type="hidden" name="Random" value="Random">
    <button class="btn btn-success" type="submit" name="random">Get Random Movie (Recommended)</button>
</form>
<hr>

<!--Number of results-->
<div class="container d-flex">
    <p id="num_results">Results: {{ movies|length }}</p>
</div>

<!--Asynchronous results of searchbar-->
<div class="container-fluid" id="new_results">
    
</div>

<!--Original default (hidden when typing into searchbar)-->
<div class="container-fluid" id="first_results">
    <div class="row row-cols-3">
        {% for movie in movies %}
        <div class="col card">
            <!--Poster-->
            {% if movie.primaryImage != None %}
                <img src="{{ movie.primaryImage.url }}" class="card-img-top w-100" alt="{{ movie.primaryImage.caption.plainText }}">  
            {% else %}
                <img src="../static/card-image.svg" class="card-img-top w-100" alt="Bootstrap">
            {% endif %}

            <!--Title and Release Date-->
            <div class="card-body">
                <h5 class="card-title">{{ movie.titleText.text }}</h5>
                <p class="card-text"><small class="text-body-secondary">
                    {% if movie.releaseDate != None %}
                        {{ movie.releaseDate.day }} / {{ movie.releaseDate.month }} / {{ movie.releaseDate.year }}
                    {% else %}
                        <p>NA</p>
                    {% endif %}
                </small></p>
            </div>

            <div class="card-footer">
                <div class="btn-group" role="group" aria-label="Advanced movie options">
                    <!--More Info button-->
                    <form action="/movie" method="get" id="movie.id" >
                        <input type="hidden" name="movie_id" value="{{ movie.id }}">
                        <button type="submit" class="btn btn-outline-primary">More info</button>
                    </form>

                    <!--Update Watchlist-->
                    {% if movie.id in movies_in_watchlist %}
                        <form name="removeWatch" id="removeWatch" action="/watchlist" method="post">
                            <input type="hidden" name="movie_id" value="{{ movie.id }}">
                            <input type="hidden" name="action" id="action" value="remove">
                            <button type="submit" class="btn btn-outline-primary" onclick="this.form.submit()">Remove from Watchlist</button>  
                        </form>
                    {% else %}
                        <form name="addWatch" id="addWatch" action="/watchlist" method="post">
                            <input type="hidden" name="movie_id" value="{{ movie.id }}">
                            <input type="hidden" name="action" id="action" value="add">
                            <button type="submit" class="btn btn-outline-primary" onclick="this.form.submit()" {{"disabled" if not session["user_id"] }}>Add to Watchlist</button>
                        </form>
                    {% endif %}   
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!--Check movies in watchlist (for js)-->
<div id="watchlist_movies" hidden>
    {{ movies_in_watchlist}}
</div>

<script>
    $('document').ready(function () {

        // When the user types in anything valid to the search form
        $('#search_form input[type="search"]').on( "keypress", function ( event ) {

            // Temporarily erase default result
            $('#first_results').hide();
            $('#num_results').html("Results: ");

            // Save the title from the searchbar
            var title = $('#search_form input[type="search"]').val();
            title = title + event.key;

            // Prepare Ajax request
            const settings = {
            async: true,
            crossDomain: true,
            url: 'https://moviesdatabase.p.rapidapi.com/titles/search/title/' + String(title) + '?exact=true&titleType=movie',
            method: 'GET',
            headers: {
                'X-RapidAPI-Key': '515955a8bbmsh7bacf3e7bb3ed33p1ef576jsna2431a83680e',
                'X-RapidAPI-Host': 'moviesdatabase.p.rapidapi.com'
            }
            };
            // Send request
            $.ajax(settings).done(function (response) {
                // Save response
                var resp = response.results;
                // Update the number of results
                $('#num_results').html("Results: " + resp.length);

                // Create a temporary div
                temp_div = $('<div class="row row-cols-3" id="temp_div"></div>');

                // Iterate through each movie from the results
                for (let i = 0; i < resp.length; i++) {
                    let movie = resp[i];

                    // Create card image
                    if (resp[i].primaryImage) {
                        card_img = '<img src="' + movie.primaryImage.url + '" class="card-img-top w-100" alt="' + movie.primaryImage.caption.plainText + '">';
                    }
                    else {
                        card_img = '<img src="../static/card-image.svg" class="card-img-top w-100" alt="Bootstrap">';
                    } 

                    // Card title
                    let card_title = '<h5 class="card-title">' + movie.titleText.text + '</h5>';

                    // Runtime
                    let date = 'NA';
                    if (movie.releaseDate) {
                        date = movie.releaseDate.day + '/' + movie.releaseDate.month + '/' + movie.releaseDate.year;
                    }
                    let card_text = `
                            <p class="card-text"><small class="text-body-secondary">
                                ` + date + `
                            </small></p>`;

                    // More Info button
                    let more_info_form = `
                        <form action="/movie" method="get" id="movie.id" >
                            <input type="hidden" name="movie_id" value="` + movie.id + `">
                            <button type="submit" class="btn btn-outline-primary">More info</button>
                        </form>
                    `;

                    // Get movies in watchlist
                    let watchlist = $('#watchlist_movies').html();
                    let id = movie.id;
                    let update_watch_form = '';
                    // Get the correct watchlist form
                    if (watchlist.includes(id)) {
                        update_watch_form = `
                            <form name="removeWatch" id="removeWatch" action="/watchlist" method="post">
                                <input type="hidden" name="movie_id" value=` + String(id) + `">
                                <input type="hidden" name="action" id="action" value="remove">
                                <button type="submit" class="btn btn-outline-primary" onclick="this.form.submit()">Remove from Watchlist</button>  
                            </form>
                        `;
                    }
                    else {
                        update_watch_form = `
                            <form name="addWatch" id="addWatch" action="/watchlist" method="post">
                                <input type="hidden" name="movie_id" value="` + String(id) + `">
                                <input type="hidden" name="action" id="action" value="add">
                                <button type="submit" class="btn btn-outline-primary" onclick="this.form.submit()" {{"disabled" if not session["user_id"] }}>Add to Watchlist</button>
                            </form>
                        `;
                    }

                    // Format the Card
                    let card = `
                    <div class="col card">
                        ` + card_img + `
                        <div class="card-body"> 
                            ` + card_title + card_text + `
                        </div>

                        <div class="card-footer">
                            <div class="btn-group" role="group" aria-label="Advanced movie options">
                                <!--Click button and it goes to more info about the movie-->
                                ` + more_info_form + `
                                <!--Update Watchlist-->
                                ` + update_watch_form + `
                            </div>
                        </div>
                    </div>`;

                    // Append card to the temporary div
                    temp_div.append(card);
                }
                // Change the html of the page to the temporary div
                $('#new_results').html( temp_div );
                // Show results
                $('#new_results').show();
            });                
        })
    })
</script>

{% endblock %}